---
layout: post
title: STM32 时钟系统
date: 2022-08-16
Author: 来自第一世界
tags: [STM32]
comments: false
---
本篇主要记录STM32时钟以及定时器的相关学习记录。

# STM32时钟

STM32主要时钟源有5个，分别为HSI、HSE、LSI、LSE、PLL。

* LSI 是低速内部时钟，RC 振荡器，频率为32kHz 左右，供独立看门狗和自动唤醒单元使用
* LSE 是低速外部时钟，接频率为32.768kHz的石英晶体，主要是RTC 的时钟源
* HSE 是高速外部时钟，可接石英/陶瓷谐振器，或者接外部时钟源，频率范围为4MHz~26MHz
* HSI 是高速内部时钟，RC 振荡器，频率为16MHz。可以直接作为系统时钟或者用作PLL输入
* PLL 为锁相环倍频输出，包括主PLL和专用PLL。主PLL由HSE 或者HSI 提供时钟信号，并具有两个不同的输出时钟。

  第一个输出PLLP，用于生成高速的系统时钟（最高168MHz），第二个输出PLLQ 用于生成USB OTG FS 的时钟（48MHz），随机数发生器的时钟和SDIO时钟。专用PLL(PLLI2S) 用于生成精确时钟，在I2S 接口实现高品质音频性能。


STM32官方库提供的打开GPIO和外设时钟的函数：

```c
void RCC_AHB1PeriphClockCmd(uint32_t RCC_AHB1Periph, FunctionalState NewState);
void RCC_AHB2PeriphClockCmd(uint32_t RCC_AHB2Periph, FunctionalState NewState);
void RCC_AHB3PeriphClockCmd(uint32_t RCC_AHB3Periph, FunctionalState NewState);
void RCC_APB1PeriphClockCmd(uint32_t RCC_APB1Periph, FunctionalState NewState);
void RCC_APB2PeriphClockCmd(uint32_t RCC_APB2Periph, FunctionalState NewState);
```

时钟源使能函数：

```c
void RCC_HSICmd(FunctionalState NewState);
void RCC_LSICmd(FunctionalState NewState);
void RCC_PLLCmd(FunctionalState NewState);
void RCC_PLLI2SCmd(FunctionalState NewState);
void RCC_PLLSAICmd(FunctionalState NewState);
void RCC_RTCCLKCmd(FunctionalState NewState);
```

时钟源配置函数：

```c
void RCC_LSEConfig(uint8_t RCC_LSE);
void RCC_SYSCLKConfig(uint32_t RCC_SYSCLKSource);
void RCC_HCLKConfig(uint32_t RCC_SYSCLK);
void RCC_PCLK1Config(uint32_t RCC_HCLK);
void RCC_PCLK2Config(uint32_t RCC_HCLK);
void RCC_RTCCLKConfig(uint32_t RCC_RTCCLKSource);
void RCC_PLLConfig(uint32_t RCC_PLLSource, uint32_t PLLM, uint32_t PLLN, uint32_t PLLP, uint32_t PLLQ);
```

外设总线挂载，来自头文件stm32f4xx_rcc.h。

```c
#define RCC_AHB1Periph_GPIOA ((uint32_t)0x00000001)
#define RCC_AHB1Periph_GPIOB ((uint32_t)0x00000002)
#define RCC_AHB1Periph_GPIOC ((uint32_t)0x00000004)

#define RCC_AHB2Periph_DCMI ((uint32_t)0x00000001)
#define RCC_AHB2Periph_CRYP ((uint32_t)0x00000010)
#define RCC_AHB2Periph_HASH ((uint32_t)0x00000020)
#define RCC_AHB2Periph_RNG ((uint32_t)0x00000040)

#define RCC_APB1Periph_TIM2 ((uint32_t)0x00000001)
#define RCC_APB1Periph_TIM3 ((uint32_t)0x00000002)
#define RCC_APB1Periph_TIM4 ((uint32_t)0x00000004)

#define RCC_APB2Periph_TIM1 ((uint32_t)0x00000001)
#define RCC_APB2Periph_TIM8 ((uint32_t)0x00000002)
#define RCC_APB2Periph_USART1 ((uint32_t)0x00000010)
#define RCC_AHB3Periph_FSMC ((uint32_t)0x00000001)
```


# STM32计时器

STM32F4 的通用定时器包含一个16 位或32 位自动重载计数器（CNT），该计数器由可编程预分频器（PSC）驱动。STM32F4 的通用定时器可以被用于：测量输入信号的脉冲长度(输入捕获)或者产生输出波形(输出比较和PWM)等。

STM32F4的定时器包括两个高级控制定时器（TIM1 和 TIM8），通用定时器（TIM2 到 TIM5）以及通用定时器（TIM9 到 TIM14）。

定时器初始化函数 `TIM_TimeBaseInit()`，定义来源于库函数文件stm32f4xx_tim.h。

```c
void TIM_TimeBaseInit(TIM_TypeDef* TIMx, TIM_TimeBaseInitTypeDef* TIM_TimeBaseInitStruct)
```

结构体定义如下：

```c
typedef struct
{
 uint16_t TIM_Prescaler;   
 uint16_t TIM_CounterMode;  
 uint32_t TIM_Period;  
 uint16_t TIM_ClockDivision;  
 uint8_t TIM_RepetitionCounter;  
} TIM_TimeBaseInitTypeDef;
```

* TIM_Prescaler：分频系数，参数可选0x0000~0xFFFF
* TIM_CounterMode：计数模式，可以设为向上计数、向下计数以及中央对齐计数方式
* TIM_Period：自动重载计数周期值，可选参数0x0000~0xFFFF
* TIM_ClockDivision：时钟分频，可选1、2以及4
* TIM_RepetitionCounter：高级计数器可用，设置自动重载值






# 定时器使用步骤

1. 时钟使能
2. 初始化定时器参数
3. 设置允许中断
4. 中断哟西安吉设置
5. 使能定时器
6. 编写中断函数
