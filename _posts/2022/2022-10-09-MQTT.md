---
layout: post
title: MQTT 学习总结
date: 2022-10-09
author: 来自第一世界
tags: [IoT]
comments: false
---
本篇总结的主要原因是最近做了一个 MQTT 相关的工作，因此总结一下这个通讯协议。

# MQTT 概述

MQTT 是一种基于客户端服务端架构的发布/订阅模式的消息传输协议。它的设计思想是轻巧、开放、简单、规范，易于实现。这些特点使得它对很多场景来说都是很好的选择，特别是对于受限的环境如机器与机器的通信（M2M）以及物联网环境（IoT）。

MQTT 最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。

MQTT 的主要特性有下面几个点：

* 使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。
* 基于TCP/IP 提供网络连接。
  主流的MQTT 是基于TCP 连接进行数据推送的，但是同样也有基于UDP 的版本，叫做MQTT-SN。这
  两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。
* 支持QoS 服务质量等级。
  根据消息的重要性不同设置不同的服务质量等级。
* 小型传输，开销很小，协议交换最小化，以降低网络流量。
  这就是为什么在介绍里说它非常适合"在物联网领域，传感器与服务器的通信，信息的收集"，要知道嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了，在手机移动应用方面，MQTT 是一种不错的Android 消息推送方案。
* 使用will 遗嘱机制来通知客户端异常断线。
* 基于主题发布/订阅消息，对负载内容屏蔽的消息传输。
* 支持心跳机制。

# MQTT 基本原理

MQTT 基于客户端-服务端架构进行消息传输，因为这是两个主要组成部分，下面介绍一些名词。

## 名词解释

### 服务端

MQTT 服务端通常是一台服务器（broker），它是 MQTT 信息传输的枢纽，负责将 MQTT 客户端发来的信息传递给 MQTT 客户端；MQTT 服务端还负责管理 MQTT 客户端，以确保客户端之间的通讯顺畅，保证MQTT 信息得以正确接收和准确投递。

### 客户端

MQTT 客户端可以向服务端发布信息，也可以从服务端收取信息；我们把客户端发送信息的行为称为“发布”信息。而客户端要想从服务端收取信息，则首先要向服务端“订阅”信息。

### 主题

“主题”在MQTT 通信中是一个非常重要的概念，客户端发布信息以及订阅信息都是围绕“主题”来进行的，并且 MQTT 服务端在管理 MQTT 信息时，也是使用“主题”来控制的。

客户端发布消息时需要为消息指定一个“主题”，表示将消息发布到该主题；而对于订阅消息的客户端来说，可通过订阅“主题”来订阅消息，这样当其它客户端或自己（当前客户端）向该主题发布消息时，MQTT 服务端就会将该主题的信息发送给该主题的订阅者（客户端）。

主题的基本形式是一个字符串，区分大小写。同时，可以利用分隔符“/”对主题进行分级。

### 发布/订阅特性

服务端对 MQTT 信息的接收、储存、处理和发送，客户端在发布和订阅信息时，可以相互独立、且在空间上可以分离、时间上可以异步，这就是MQTT 发布/订阅的特性：客户端相互独立、空间上可分离、时间上可异步。

这里解释一下时间上的异步。如果开发板发生的断电的情况，与 MQTT 服务器断开连接，在开发板再次上线之后，服务端可以继续推送信息，这样实际上是一个异步的工作状态。

### MQTT 报文

MQTT 报文组成分为三个部分：固定头（Fixed header）、可变头（Variableheader）以及有效载荷（Payload，消息体）。

* 固定头（Fixed header）：存在于所有MQTT 报文中，固定头中有报文类型标识，可用于识别是哪种MQTT 报文，譬如该报文是CONNECT 报文还是CONNACK 报文，亦或是其它类型报文。
* 可变头（Variable header）：存在于部分类型的MQTT 报文中，报文的类型决定了可变头是否存在及其具体的内容。
* 消息体（Payload）：存在于部分类型的MQTT 报文中，payload 就是消息载体的意思。

### Qos

MQTT 设计了一套保证消息稳定传输的机制，包括消息应答、存储和重传。在这套机制下，提供了三种不同级别的 QoS（Quality of Service），也就是 MQTT 协议有三种服务质量等级：

* QoS = 0：最多发一次；
* QoS = 1：最少发一次；
* QoS = 2：保证收一次。

对于比较重要的信息，一般选择 Qos ＞ 0 的质量等级。

#### Qos = 0

即消息只发送一次，无论发送成功还是发送失败。

#### Qos = 1

当 QoS 级别为1 时，发送端在消息发送完成后，会检查接收端是否已经成功接收到了消息。

#### Qos = 2

当 MQTT 服务质量为2 级时，MQTT 协议可以确保接收端只接收一次消息。与 Qos = 1 不同，Qos = 1 时接收端收到的消息次数可能不止一次。

## 工作流程

### 连接MQTT服务端

事实上，这一动作包括两个步骤。首先客户端需要向服务端发送连接请求，即一个 CONNECT 报文，然后 MQTT 服务端返回一个 CONNACK 报文。

#### CONNECT 报文

CONNECT 报文的内容很多，主要是服务端的ID（clientId），心跳间隔（keepAlive）以及是否清理会话（cleanSession），这三个是必须有的内容，剩下的则是可选内容。

#### CONNACK 报文

CONNACK报文包括连部分，一个是连接返回码（returnCode），另一个是会话存在（sessionPresent）。

返回码为 0 表示连接成功，为其他数字一般表示拒绝连接，不同的数字表示不同的连接失败的原因。

会话存在（sessionPresent）与是否清理会话（cleanSession）密切相关，为 1 表示存储了上次连接的会话状态，为 0 则没有。

### 断开连接

当服务端要与客户端断开连接时，可以发送 DISCONNECT 报文。

### 消息传输

消息传输主要包括发布和订阅，这两部分都围绕着主题这一核心。

#### 发布（PUBLISH）

MQTT 客户端向服务端发布消息其实就是向服务端发送一个PUBLISH 报文，服务端收到客户端发送过来的PUBLISH 报文之后，会向发送发回复一个报文。

这里有个Qos（Quality of Service）表示消息质量等级，需要注意。

#### 订阅（SUBSCRIBE）

订阅的含义是订阅该消息的注意后，当有客户端向该主题发布消息后，订阅了该主题的客户端就能接收到消息。

订阅之后还有取消订阅（UNSUBSCRIBE）这一功能。

## MQTT 命令

本节记录一下 MQTT 常用的一些命令。

### 一般命令：

| 作用         | 命令                          | 备注                           |
| ------------ | ----------------------------- | ------------------------------ |
| 启动代理服务 | mosquitto -v                  | -v 打印更多信息                |
| 订阅主题     | mosquitto_sub -v -t sensor    | -t 主题（sensor）；-v 更多信息 |
| 发布内容     | mosquitto_pub -t sensor -m 12 | -m 消息内容（12）              |

### mosquitto_pub（发布）用法

|  |  |  |
| - | - | - |

| 命令           | 代表·       | 含义                                                                                                                         |
| -------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| -d             | debug        | 开启debug选项                                                                                                                |
| -f             | file         | 把一个文件的内容做为消息的内容发送。经测试，支持txt文件，不支持doc等其他形式文件                                             |
| -h             | host         | 说明所连接到的域名，默认是localhost                                                                                          |
| -i             | id           | 客户端的ID号，如果没有指定，默认是mosquitto_pub_加上客户端的进程id，不能和–id_prefix同时使用                                |
| -I             | id-prefix    | 指定客户端ID的前缀，与客户端的进程ID连接组成客户端的ID，不能和–id同时使用                                                   |
| -l             | stdin-line   | 从总段读取输入发送消息，一行为一条消息，空白行不会被发送                                                                     |
| -m             | message      | 从命令行发送一条消息，-m后面跟发送的消息内容                                                                                 |
| -n             | null-message | 发送一条空消息                                                                                                               |
| -p             | port         | 连接的端口号，默认是1883.                                                                                                    |
| -P             | pw           | 指定密码用于代理认证，使用此选项时必须有有效的用户名。                                                                       |
| -q             | qos          | 指定消息的服务质量，可以为0,1,2，默认是0                                                                                     |
| –quiet        | quiet        | 如果指定该选项，则不会有任何错误被打印，当然，这排除了无效的用户输入所引起的错误消息                                         |
| -r             | retain       | 如果指定该选项，该条消息将被保留做为最后一条收到的消息。下一个订阅消息者将能至少收到该条消息。                               |
| -s             | stdin-file   | 从标准输入接收传输的消息内容，所有输入做为一条消息发送。                                                                     |
| -t             | topic        | 指定消息所发布到哪个主题。                                                                                                   |
| -u             | username     | 指定用户名用于代理认证。                                                                                                     |
| –will-payload |              | 如果指定该选项，则万一客户端意外和代理服务器断开，则该消息将被保留在服务端并发送出去，该选项必须同时用–will-topic指定主题。 |
| –will-qos     |              | 指定Will的服务质量，默认是0.必须和选项 –will-topic同时使用.                                                                 |
| –will-retain  |              | 如果指定该选项，则万一客户端意外断开，已被发送的消息将被当做retained消息。必须和选项 –will-topic同时使用.                   |
| –will-topic   |              | 指定客户端意外断开时，Will消息发送到的主题。                                                                                 |

sad

### mosquitto_sub（订阅）用法
