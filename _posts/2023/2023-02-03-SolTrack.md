---
layout: post
title: 光伏支架追踪算法解析
date: 2023-02-03
author: 来自第一世界
tags: [algorithm]
comments: false
---
光伏支架控制器用于实现对于太阳的跟踪，以实现最大效率的光能转换，本篇主要分析追踪算法的实现流程和计算原理。

# 总体概述

一个基本的光伏支架控制器如图所示。

![img](https://raw.githubusercontent.com/Balculus/picbed/master/2022/202302061155205.png "光伏支架控制器")

这里暂时考虑只有一个自由度的光伏支架，图上的两个支架是东西方向摆动，实际上是一横排光伏支架的侧视图，需要个图。

设两个光伏支架的距离为 $l$，光伏板的长度为 $w$，太阳阳光在光伏板上的入射角设为 $\theta$，光伏支架额倾斜角度为 $\gamma$。
当太阳光的入射角度和光伏支架的倾斜角度垂直时，光能转换效率最大。整体算法以此为基础。

# 追踪算法

## 太阳角度计算

太阳角度计算实际上是在已知当地的地理位置信息和时间信息的情况下获得太阳的位置信息。这里太阳的位置信息是通过地平坐标系得来的，因此首先介绍地平坐标系。

### 地平坐标系

地平坐标系的介绍如下，来源于维基百科。

> **地平坐标系** （Horizontal coordinate system），是天球坐标系统中的一种，以观测者所在地为中心点，所在地的地平线作为基础平面，将天球适当的分成能看见的上半球和看不见（被地球本身遮蔽）的下半球。上半球的顶点（最高点）称为天顶，下半球的顶点（最低点）称为地底。
>
> 地平坐标系统由两个夹角来定义一个天体位置的极座标：
>
> * 高度角（Altitude, Alt）或仰角又称地平纬度，是天体和观测者所在地的地平线的夹角；
> * 方位角（Azimuth, Az）又称地平经度，是沿着地平线测量的角度. 一般文献指称的方位角是以正北方为 $0^{\circ}$ 度起点, 顺时钟向东方测量。 但对于某些观星者或航海家而言, 定义以南方为 $0^{\circ}$ 度起点的方向角, 有其方便性。

在此算法中，以南为 $0^{\circ}$ 起点。简单来说，在地平面上，正向南方，太阳在地平面的投影角度就是方位角，而太阳在南北方向和地平面垂直平面的投射角度就是高度角。

![](https://raw.githubusercontent.com/Balculus/picbed/master/2023/202302081026648.png "地平坐标系")

维基百科中描述：

**方位角**可分为由北点开始向东方顺时钟方向所定义的北方位角(如图中所示两条蓝线夹角)，或是从南点向西方顺时钟方向所定义的南方位角(如图中红色弧线所示夹角)，**高度角**为星体与地平面的夹角（绿色弧线夹角）

有了高度角和方位角，就可以得出太阳的位置，继而进行算法的下一步计算。

### 太阳位置计算

太阳位置计算方面算法使用了现有的 [SolTrack-Python](https://github.com/MarcvdSluys/SolTrack-Python/) 程序包。

算法输入参数包括 gps 信息以及时间信息，输出为太阳的地平坐标参数。

算法包括[例程](https://github.com/MarcvdSluys/SolTrack-Python/)，[论文](https://arxiv.org/abs/2209.01557)，[文档](https://soltrack.readthedocs.io/en/latest/soltrack.html)，这里不在详细描述。

总而言之，我们现在得到了光伏支架所在地的太阳位置信息，可以进行光伏支架本身的追踪算法设计了。

### 太阳入射角度计算

如果光伏支架存在两个自由度，那么可以直接通过调整光伏板的位置使其和太阳入射角度垂直，但是如果光伏支架为前面所描述的，只能在东西方向摆动，那么太阳光对光伏支架的入射角度还需要进行处理。

![太阳入射角](https://raw.githubusercontent.com/Balculus/picbed/master/2023/202302081146118.png "太阳入射角度计算")

如图所示，设光伏支架位置为 $O$，太阳位置为 $A$，角 $Az$ 为方位角，角 $Alt$ 为高度角，通过上节算法计算得来。太阳到光伏支架的距离为 $L$，高度为 $h$，与光伏支架的水平距离为 $d$。

$$
\angle 1 = \frac{h}{d} =\frac{L \times sin\left ( Alt \right  ) }{L \times cos\left ( Alt \right  )\times sin \left ( Az \right  )}=\frac{tan\left ( Alt \right  )}{sin\left ( Az \right  )}
$$

由此可以求得 $\angle 1$ 为太阳入射角  $\theta$

## 正常追踪算法

正常追踪算法只要保持光伏支架板和太阳入射角垂直即可：

$$
\theta + \gamma = 90^{\circ}
$$

即：

$$
\gamma = 90^{\circ} - \theta
$$

## 逆追踪算法

实际上，保持垂直角度的跟踪并不总是奏效，下图展示了这种情况。

![img](https://raw.githubusercontent.com/Balculus/picbed/master/2023/202302081328599.png)

当太阳的角度过低，光伏支架板为了垂直于入射角，会对后面的光伏之间板造成遮挡，减少了太阳光的接收效率，这种情况是不能接受的。

因此，逆追踪算法就是针对这种情况出现。其主要思想是光伏支架的角度随太阳入射角而变化，保持相同的增加或减少。

考虑极限情况如下图所示。

![](https://raw.githubusercontent.com/Balculus/picbed/master/2023/202302081402650.png)

太阳的入射角 $\theta$ 与 $\gamma$ 垂直且恰好没有遮挡，此时太阳入射角为：

$$
\theta_c = sin(\frac{w}{l})
$$

当 $ \theta < \theta_c $ 时，应该采用逆追踪算法。

当太阳入射角度 $\theta$ 逐渐变小，那么 $\gamma$ 也应该变下，光伏板长 $w$ 和 $l$ 以及太阳入射角三个已知量构成一个三角形，由正弦定理可得

$$
\frac{w}{sin(\theta)} = \frac{l}{sin(\theta + \gamma)}
$$

那么可以得到光伏板的期望转角为：

$$
\gamma = arcsin(\frac{l}{w}\times sin(\theta)) - \theta
$$

# 一些细节问题

## 角度问题

事实上，在实施过程中，角度的正负和大小问题是需要考虑进去的。太阳在东方时，方位角为负，在西方是，方位角为正。

如果光伏板是东西摆向，那么整体的角度变化为：

$$
0^{\circ} \to -45^{\circ} \to 0^{\circ} \to 45^{\circ} \to 0^{\circ}

$$

简单的解决思路是上午为负，下午为正。